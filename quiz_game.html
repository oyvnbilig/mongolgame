<!DOCTYPE html>
<html lang="mn">    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Game</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<style>
    /* 游戏页主内容布局 */
    .game-layout {
        flex: 1; height: 100%;
        display: flex;
        /* 竖排下 row = 垂直排列 (Picture Top, Quiz Bottom) */
        flex-direction: row; 
        padding: 20px; gap: 20px;
        overflow-x: auto; overflow-y: hidden;
    }

    /* 1. 图片展示区 */
    .media-strip {
        /* 高度固定，宽度自适应 */
        width: 100%; height: 220px; 
        flex-shrink: 0;
        display: none; /* JS控制显隐 */
        /* 竖排下 column = 水平排列 (图片左右排布) */
        flex-direction: column; 
        gap: 15px;
    }

    .media-card {
        background: var(--surface-color);
        width: 220px; height: 100%;
        border-radius: var(--radius-md);
        padding: 8px;
        box-shadow: var(--shadow-sm);
        display: flex; align-items: center; justify-content: center;
        /* 图片容器内回归横排 */
        writing-mode: horizontal-tb;
    }
    .media-img {
        width: 100%; height: 100%; object-fit: contain;
        border-radius: 8px;
    }

    /* 2. 答题核心区 */
    .quiz-card {
        flex: 1; /* 占据剩余垂直空间 */
        width: 100%; /* 撑满宽度 */
        background: var(--surface-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 30px;
        display: flex;
        flex-direction: column; /* 竖排下 column = 向右排列 (Title -> Options -> Btn) */
        gap: 40px;
    }

    /* 题目文字 */
    .question-text {
        font-size: 24px; font-weight: 900;
        line-height: 1.8; color: var(--text-main);
        text-align: justify;
        /* 限制题目最大高度（即横排的宽度），防止太长 */
        max-height: 85vh; 
    }

    /* 选项组容器 */
    .options-group {
        display: flex;
        /* 修正：row = 垂直排列 (A, B, C...) */
        flex-direction: row; 
        flex-wrap: wrap; /* 向右换列 */
        gap: 15px;
        height: 100%; /* 撑满高度，强迫换列 */
        align-content: flex-start;
    }

    /* 选项按钮 */
    .option-btn {
        background: var(--background-color);
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 15px 20px;
        cursor: pointer;
        /* 保证选项有足够高度 */
        min-height: 100px; max-width: 120px;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
        font-size: 16px; font-weight: bold; color: var(--text-main);
        text-align: center;
    }
    
    .option-btn:hover { background: #e2e8f0; }
    .option-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .option-btn.correct { background: var(--success); color: white; border-color: var(--success); }
    .option-btn.wrong { background: var(--error); color: white; border-color: var(--error); }

    /* 底部操作栏 */
    .action-bar {
        padding-left: 20px;
        border-left: 1px solid #e2e8f0;
        display: flex; flex-direction: column; justify-content: flex-end;
    }
    
    /* 下一题按钮 (长条形) */
    .next-fab {
        writing-mode: vertical-lr;
        padding: 30px 15px;
        font-size: 18px; letter-spacing: 4px;
        border-radius: 20px;
    }

    /* 计时器徽章 */
    .timer-badge {
        writing-mode: vertical-lr;
        background: #fef3c7; color: #d97706;
        padding: 8px 6px; border-radius: 8px;
        font-weight: bold; font-family: monospace;
        font-size: 12px;
    }

</style>
<body>
    <div class="app-shell">
         <!-- 侧边栏 -->
         <nav class="sidebar-nav">
             <div class="nav-btn" onclick="history.back()"><i class="fa-solid fa-xmark"></i></div>
             <div class="timer-badge" id="timer">00:00</div>
             <div style="width: 48px;"></div>
         </nav>

         <!-- 游戏主布局 -->
         <main class="game-layout scroll-hide">
            
            <!-- A. 图片区 (动态) -->
            <div class="media-strip scroll-hide" id="media-area">
                <!-- JS Inject Images -->
            </div>

            <!-- B. 答题区 -->
            <div class="quiz-card scroll-hide">
                <!-- 1. 题目 -->
                <div class="question-text" id="q-text">Loading...</div>
                
                <!-- 2. 选项 -->
                <div class="options-group" id="opt-area">
                    <!-- JS Inject Options -->
                </div>

                <!-- 3. 操作 -->
                <div class="action-bar">
                    <button id="next-btn" class="btn-primary next-fab" disabled>
                        ᠳᠠᠷᠠᠭᠠᠬᠢ <!-- Next -->
                    </button>
                </div>
            </div>
         </main>
    </div> 

    <!-- 结算弹窗 -->
    <div id="result-modal" class="modal-backdrop">
        <div class="modal-card">
            <h2 style="margin:0; color:var(--text-main);">ᠳ᠋ᠦᠩ</h2> <!-- Score -->
            <div style="font-size:48px; font-weight:900; color:var(--primary-color);" id="final-score">0/0</div>
            
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn-primary" onclick="location.reload()">
                    <i class="fa-solid fa-rotate-right" style="margin-bottom:8px;"></i> ᠳᠠᠬᠢᠵᠤ
                </button>
                <button class="btn-primary" style="background:#e2e8f0; color:#475569;" onclick="history.back()">
                     ᠪᠤᠴᠠᠬᠤ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { questions } from './js/data.js';

        const params = new URLSearchParams(window.location.search);
        const category = params.get('category');
        
        // 状态
        let list = [];
        let currIdx = 0;
        let score = 0;
        let hasAnswered = false;
        let timerSec = 0;
        let timerId = null;

        // 元素
        const els = {
            mediaArea: document.getElementById('media-area'),
            qText: document.getElementById('q-text'),
            optArea: document.getElementById('opt-area'),
            nextBtn: document.getElementById('next-btn'),
            modal: document.getElementById('result-modal'),
            scoreDisplay: document.getElementById('final-score'),
            timer: document.getElementById('timer')
        };

        function init() {
            if (!category) { alert('Category Error'); return; }
            
            // 筛选并乱序
            list = questions.filter(q => q.category === category).sort(() => Math.random() - 0.5);
            
            if (list.length === 0) {
                els.qText.innerText = "No questions in this category.";
                return;
            }

            startTimer();
            loadQuestion();
        }

        function loadQuestion() {
            if (currIdx >= list.length) {
                finish();
                return;
            }

            const data = list[currIdx];
            hasAnswered = false;
            
            // 按钮状态
            els.nextBtn.disabled = true;
            els.nextBtn.innerHTML = (currIdx === list.length - 1) ? 
                '<i class="fa-solid fa-flag-checkered"></i>' : // Finish icon
                'ᠳᠠᠷᠠᠭᠠᠬᠢ'; // Next text

            // 1. 渲染题目
            els.qText.innerText = data.question;

            // 2. 渲染图片 (智能显隐)
            els.mediaArea.innerHTML = '';
            const imgs = Array.isArray(data.image) ? data.image : (data.image ? [data.image] : []);
            
            if (imgs.length > 0) {
                els.mediaArea.style.display = 'flex'; // 显示图片区
                imgs.forEach(src => {
                    const card = document.createElement('div');
                    card.className = 'media-card';
                    card.innerHTML = `<img src="${src}" class="media-img" loading="lazy">`;
                    els.mediaArea.appendChild(card);
                });
            } else {
                els.mediaArea.style.display = 'none'; // 隐藏图片区，让quiz-card自动变大
            }

            // 3. 渲染选项
            els.optArea.innerHTML = '';
            // 创建带索引的选项对象以进行对比
            const opts = data.options.map((txt, idx) => ({ txt, idx })).sort(() => Math.random() - 0.5);

            opts.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = opt.txt;
                btn.onclick = () => check(btn, opt.idx, data.correct);
                els.optArea.appendChild(btn);
            });

            // 视图复位：滚回最左边
            document.querySelector('.game-layout').scrollLeft = 0;
            // 确保选项区域也滚回顶部(物理上是顶部)
            els.optArea.scrollLeft = 0; 
        }

        function check(btn, idx, correct) {
            if (hasAnswered) return;
            hasAnswered = true;

            if (idx === correct) {
                btn.classList.add('selected', 'correct'); // 绿色
                score++;
            } else {
                btn.classList.add('selected', 'wrong'); // 红色
                // 可选：高亮正确答案
            }
            els.nextBtn.disabled = false;
        }

        els.nextBtn.onclick = () => {
            currIdx++;
            loadQuestion();
        };

        function startTimer() {
            timerId = setInterval(() => {
                timerSec++;
                const m = Math.floor(timerSec / 60).toString().padStart(2, '0');
                const s = (timerSec % 60).toString().padStart(2, '0');
                els.timer.innerText = `${m}:${s}`;
            }, 1000);
        }

        function finish() {
            clearInterval(timerId);
            els.scoreDisplay.innerText = `${score} / ${list.length}`;
            els.modal.style.display = 'flex';
        }

        init();
    </script>
</body>
</html>